---
id: contextual-conversations
sidebar_label: Complex Contextual Conversations
title: Complex Contextual Conversations
---


In a contextual conversation, your assistant considers more more just the last
user message and responds differently based on the conversation history. 

For example, if a user asks Sara, the Rasa bot, how to get started using Rasa,
Sara gives the user
different information based on whether they've built an AI assistant before or are
migrating from a different tool:

A conversation with a new user goes like this:
```yaml
## TODO
```

A conversation with a migrating user is a little different:
```yaml
## TODO
```

This page is a guide to creating contextual conversation patterns. 

## Concepts

For an assistant to be context-sensitive, it needs keep track of relevant parts of the conversation.
<!-- it automatiaclly keeps track of a certain number of turns defined by max_history. For things
that should last longer than max history, you should use slots-->

### `max_history`

Usually, only a certain amount of context is relevant to your assistant. 
[`max_history`](policies.mdx#max-history) is a hyperparameter for Rasa dialogue management policies
that controls how much dialogue history the model looks at to decide which
action to take next. 

You can set the `max_history` by passing it to your policy's `Featurizer`
in the policy configuration yaml file:

<!--TODO: Complete this section based on a better understanding of 
policies in 2.0 esp re. priorities & memoization-->

You want to make sure `max_history` is set high enough
to account for the most context your assistant will need to make an accurate 
prediction about awhat to do next.

### Slots

[Slots](domain.mdx#slots) are your assistant's memory. Slots store pieces of information that your
assistant needs to refer to later, especially when you don't know how much later. 
Slots can be automatically filled by entities of the 
same name, or they can be filled by a custom action. For example, a custom action could retrieve
information about a user from a database and store that in slots. Slots direct the flow of the conversation
based on `slot_was_set` events. There are different [types of slots](domain.mdx#slot-types),
and each affects the conversation flow in its own way. 

In the getting started example, the bot needs to know whether a user is new to building bots.
You can define a slot called `new_user` in your domain:

```yaml
slots:
  new_user:
    - type: text
```

The slot is a `text` slot,
which means it doesn't matter what the value of the slot is, the only thing that 
affects the dialogue is whether it is set or not. The slot gets set by the entity of the same name
(see the [training data](#nlu-training-data) for this example).

You can now include a `slot_was_set` event in your stories to change the conversation flow.
For example:

```yaml
stories:
  - story: New user
    steps:
    - intent: get_started
      entities:
      - new_user
    - slot_was_set:
      - new_user
    - action: utter_welcome_new_user
    - action: utter_ask_built_bots

  - story: Not new user
    steps:
    - intent: get_started
    - action: utter_welcome
    - action: utter_ask_migrating
```

In the example above, the steps immediately after the user message `get_started` diverge
based on whether the `new_user` slot was set. However, you could also use the slot much
later in the conversation.

### Saving Real Conversations as Stories

It's difficult to know ahead of time exactly which conversation
contexts the bot will encounter since your users will probably take conversation paths you didn't expect. 
One of the best ways to improve your assistant's contextual skills 
is to take real conversations as training data, after correcting where
the bot went wrong if necessary. When doing so, pay attention
to slot and entity values and make sure to [test your assistant](testing-your-assistant.mdx)
thoroughly to make sure your changes don't introduce regressions. 

### Using Machine Learning Policies to Generalise

In addition to adding stories to account for context,
machine learning policies can help your model generalize
to unseeen conversation paths. These policies
come in as an additional layer in your policy configuration,
and only jump in if the user follows a path that you have not anticipated. **It is important
to understand that using machine-learning policies does not mean letting go of control over your
assistant.** If a rule based policy is able to make a prediction, that prediction will
always have a higher priority (read more [here](./policies.mdx#action-selection)) and predict the next action. The
machine-learning based policies give your assistant the chance not to fail, whereas if they are not
used your assistant will definitely fail, like in state machine based dialogue systems.

Unexpected user behaviors are something the [`TEDPolicy`](https://blog.rasa.com/unpacking-the-ted-policy-in-rasa-open-source/) deals with
very well. It can learn to bring the user back on track after some
interjections during the main user goal the user is trying to complete. For example,
in the conversation below (extracted from a conversation on [Rasa X](https://rasa.com/docs/rasa-x/user-guide/review-conversations/)):

```md
<!--TODO: convert to new format-->
## Story from conversation with a2baab6c83054bfaa8d598459c659d2a on November 28th 2019
* greet
  - action_greet_user
  - slot{"shown_privacy":true}
* ask_whoisit
  - action_chitchat
* ask_whatspossible
  - action_chitchat
* telljoke
  - action_chitchat
* how_to_get_started{"product":"x"}
  - slot{"product":"x"}
  - utter_explain_x
  - utter_also_explain_nlucore
* affirm
  - utter_explain_nlu
  - utter_explain_core
  - utter_direct_to_step2
```

Here we can see the user has completed a few chitchat tasks first, and then ultimately
asks how they can get started with Rasa X. The `TEDPolicy` correctly predicts that
Rasa X should be explained to the user, and then also takes them down the getting started
path, without asking all the qualifying questions first.

Since the machine-learning policy generalized well in this situation, it makes sense to add this story
to your training data to continuously improve your bot and help the model generalize
better in future. [Rasa X](https://rasa.com/docs/rasa-x/) is a tool that can help
you improve your bot and make it more contextual.
